name: Deploy GitHub Pages

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**'
  workflow_dispatch:
  workflow_run:
    workflows: ["Run Benchmarks"]
    types: [completed]
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Download JSON from latest release
        run: |
          echo "Downloading JSON from latest release..."
          RELEASE_TAG="benchmarks-latest"
          mkdir -p docs/data
          
          RELEASE_JSON=$(gh release view "$RELEASE_TAG" --repo ${{ github.repository }} --json assets,id,createdAt 2>/dev/null || echo "")
          if [ -z "$RELEASE_JSON" ]; then
            echo "ERROR: No release found with tag $RELEASE_TAG"
            echo "The benchmarks workflow must run and create a release first."
            echo '{"error": "No release found", "summary": {"total_benchmarks": 0}}' > docs/data/benchmark-results-consolidated-latest.json
            exit 0
          fi
          
          echo "Release found. Assets:"
          echo "$RELEASE_JSON" | jq -r '.assets[] | .name' || echo "  (none)"
          
          echo "Searching for JSON asset in release..."
          echo "All assets:"
          echo "$RELEASE_JSON" | jq -r '.assets[] | "  - \(.name) (\(.size) bytes)"' || echo "  (none)"
          
          # Debug: show what jq sees
          echo "Debug: Testing jq queries..."
          echo "Exact match test:"
          echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name == "benchmark-results-consolidated-latest.json") | .name' || echo "  (failed)"
          echo "Contains test:"
          echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name | contains("benchmark-results-consolidated")) | .name' || echo "  (failed)"
          echo "Ends with .json test (using test()):"
          echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name | test("\\.json$")) | .name' || echo "  (failed)"
          
          # First try exact filename match (most reliable)
          JSON_ASSET_URL=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name == "benchmark-results-consolidated-latest.json") | .browser_download_url' | head -1)
          if [ -n "$JSON_ASSET_URL" ] && [ "$JSON_ASSET_URL" != "null" ]; then
            echo "✅ Found JSON asset by exact filename match"
          else
            # If not found, try contains pattern with test() for .json
            echo "Exact match not found, trying contains pattern..."
            JSON_ASSET_URL=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name | contains("benchmark-results-consolidated") and test("\\.json$")) | .browser_download_url' | head -1)
            if [ -n "$JSON_ASSET_URL" ] && [ "$JSON_ASSET_URL" != "null" ]; then
              echo "✅ Found JSON asset by contains pattern"
            else
              # If still not found, try any .json file using test()
              echo "Contains pattern not found, trying any .json file..."
              JSON_ASSET_URL=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name | test("\\.json$")) | .browser_download_url' | head -1)
              if [ -n "$JSON_ASSET_URL" ] && [ "$JSON_ASSET_URL" != "null" ]; then
                echo "✅ Found JSON asset by .json pattern"
              fi
            fi
          fi
          
          if [ -z "$JSON_ASSET_URL" ] || [ "$JSON_ASSET_URL" = "null" ]; then
            echo "ERROR: No JSON asset found in release"
            echo "Searched for:"
            echo "  - Files containing 'benchmark-results-consolidated' and ending with '.json'"
            echo "  - Any file ending with '.json'"
            echo "Available assets:"
            echo "$RELEASE_JSON" | jq -r '.assets[] | "  - \(.name) (\(.size) bytes)"' || echo "  (none)"
            echo "This is a critical error - the release should contain the JSON file."
            echo "Check that the benchmarks workflow completed successfully and created the release."
            echo '{"error": "No JSON asset in release", "summary": {"total_benchmarks": 0}}' > docs/data/benchmark-results-consolidated-latest.json
            exit 1
          fi
          
          echo "Found JSON asset: $JSON_ASSET_URL"
          curl -L -f -o docs/data/benchmark-results-consolidated-latest.json "$JSON_ASSET_URL"
          
          if [ ! -f "docs/data/benchmark-results-consolidated-latest.json" ]; then
            echo "ERROR: Failed to download JSON file"
            echo '{"error": "Download failed", "summary": {"total_benchmarks": 0}}' > docs/data/benchmark-results-consolidated-latest.json
            exit 1
          fi
          
          FILE_SIZE=$(wc -c < docs/data/benchmark-results-consolidated-latest.json)
          echo "Downloaded JSON file, size: $FILE_SIZE bytes"
          
          if [ "$FILE_SIZE" -lt 100 ]; then
            echo "WARNING: JSON file is very small ($FILE_SIZE bytes), may be empty or invalid"
            echo "File content:"
            head -20 docs/data/benchmark-results-consolidated-latest.json
          fi
          
          if command -v jq &> /dev/null; then
            echo "Validating JSON structure..."
            if ! jq empty docs/data/benchmark-results-consolidated-latest.json 2>/dev/null; then
              echo "ERROR: Downloaded file is not valid JSON"
              echo "First 500 chars:"
              head -c 500 docs/data/benchmark-results-consolidated-latest.json
              exit 1
            fi
            
            BENCH_COUNT=$(jq -r '.summary.total_benchmarks // 0' docs/data/benchmark-results-consolidated-latest.json 2>/dev/null || echo "0")
            CORE_COUNT=$(jq -r '.summary.core_benchmarks // 0' docs/data/benchmark-results-consolidated-latest.json 2>/dev/null || echo "0")
            COMMONS_COUNT=$(jq -r '.summary.commons_benchmarks // 0' docs/data/benchmark-results-consolidated-latest.json 2>/dev/null || echo "0")
            COMPARISONS=$(jq -r '.summary.comparisons // 0' docs/data/benchmark-results-consolidated-latest.json 2>/dev/null || echo "0")
            
            echo "JSON summary:"
            echo "  Total benchmarks: $BENCH_COUNT"
            echo "  Core benchmarks: $CORE_COUNT"
            echo "  Commons benchmarks: $COMMONS_COUNT"
            echo "  Comparisons: $COMPARISONS"
            
            if [ "$BENCH_COUNT" = "0" ]; then
              echo "WARNING: JSON file has 0 benchmarks. The release may contain an empty file."
              echo "This usually means the benchmarks workflow failed or produced no results."
            fi
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
