name: Run Benchmarks (Manual)

on:
  workflow_dispatch:
    inputs:
      suite:
        description: 'Benchmark suite to run'
        required: true
        default: 'fair'
        type: choice
        options:
          - fair
          - fair-fast
          - all
          - core-only
          - commons-only

jobs:
  run-benchmarks:
    runs-on: [self-hosted, linux]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Setup dependencies (Core and Commons)
        id: setup
        run: |
          echo "Setting up Bitcoin Core and Bitcoin Commons..."
          
          # Setup Core
          CORE_DIR="$HOME/bitcoin-core"
          if [ ! -d "$CORE_DIR" ]; then
            echo "Cloning Bitcoin Core to $CORE_DIR..."
            git clone --depth 1 https://github.com/bitcoin/bitcoin.git "$CORE_DIR" || {
              echo "‚ùå Failed to clone Core"
              exit 1
            }
          else
            echo "‚úÖ Bitcoin Core already exists at $CORE_DIR"
          fi
          
          # Setup Commons consensus
          CONSENSUS_DIR="$HOME/bllvm-consensus"
          if [ ! -d "$CONSENSUS_DIR" ]; then
            echo "Cloning Bitcoin Commons (bllvm-consensus) to $CONSENSUS_DIR..."
            git clone --depth 1 https://github.com/BTCDecoded/bllvm-consensus.git "$CONSENSUS_DIR" || {
              echo "‚ùå Failed to clone bllvm-consensus"
              exit 1
            }
          else
            echo "‚úÖ bllvm-consensus already exists at $CONSENSUS_DIR"
          fi
          
          # Setup Commons node
          NODE_DIR="$HOME/bllvm-node"
          if [ ! -d "$NODE_DIR" ]; then
            echo "Cloning Bitcoin Commons (bllvm-node) to $NODE_DIR..."
            git clone --depth 1 https://github.com/BTCDecoded/bllvm-node.git "$NODE_DIR" || {
              echo "‚ùå Failed to clone bllvm-node"
              exit 1
            }
          else
            echo "‚úÖ bllvm-node already exists at $NODE_DIR"
          fi
          
          # Verify directories exist
          if [ ! -d "$CORE_DIR" ]; then
            echo "‚ùå Core directory does not exist: $CORE_DIR"
            exit 1
          fi
          if [ ! -d "$CONSENSUS_DIR" ]; then
            echo "‚ùå Consensus directory does not exist: $CONSENSUS_DIR"
            exit 1
          fi
          if [ ! -d "$NODE_DIR" ]; then
            echo "‚ùå Node directory does not exist: $NODE_DIR"
            exit 1
          fi
          
          # Create config.toml with absolute paths
          mkdir -p config
          cat > config/config.toml << EOF
[paths]
core_path = "$CORE_DIR"
commons_consensus_path = "$CONSENSUS_DIR"
commons_node_path = "$NODE_DIR"
EOF
          echo "‚úÖ Created config/config.toml"
          
          # Export paths for this step
          echo "core_path=$CORE_DIR" >> $GITHUB_OUTPUT
          echo "commons_consensus_path=$CONSENSUS_DIR" >> $GITHUB_OUTPUT
          echo "commons_node_path=$NODE_DIR" >> $GITHUB_OUTPUT
          
          echo ""
          echo "‚úÖ Setup complete:"
          echo "  CORE_PATH: $CORE_DIR"
          echo "  COMMONS_CONSENSUS_PATH: $CONSENSUS_DIR"
          echo "  COMMONS_NODE_PATH: $NODE_DIR"

      - name: Run benchmarks
        env:
          RUSTFLAGS: "-C target-cpu=native"
          CORE_PATH: ${{ steps.setup.outputs.core_path }}
          COMMONS_CONSENSUS_PATH: ${{ steps.setup.outputs.commons_consensus_path }}
          COMMONS_NODE_PATH: ${{ steps.setup.outputs.commons_node_path }}
        run: |
          # Explicitly export paths BEFORE running any scripts
          export CORE_PATH="$CORE_PATH"
          export COMMONS_CONSENSUS_PATH="$COMMONS_CONSENSUS_PATH"
          export COMMONS_NODE_PATH="$COMMONS_NODE_PATH"
          export BLLVM_BENCH_CONFIG="$(pwd)/config/config.toml"
          
          echo "Running benchmarks with paths:"
          echo "  CORE_PATH: $CORE_PATH"
          echo "  COMMONS_CONSENSUS_PATH: $COMMONS_CONSENSUS_PATH"
          echo "  COMMONS_NODE_PATH: $COMMONS_NODE_PATH"
          echo "  Config file: $BLLVM_BENCH_CONFIG"
          
          # Verify paths exist
          if [ ! -d "$COMMONS_CONSENSUS_PATH" ]; then
            echo "‚ùå COMMONS_CONSENSUS_PATH does not exist: $COMMONS_CONSENSUS_PATH"
            exit 1
          fi
          if [ ! -d "$COMMONS_NODE_PATH" ]; then
            echo "‚ùå COMMONS_NODE_PATH does not exist: $COMMONS_NODE_PATH"
            exit 1
          fi
          
          # Verify config file exists
          if [ ! -f "$BLLVM_BENCH_CONFIG" ]; then
            echo "‚ùå Config file does not exist: $BLLVM_BENCH_CONFIG"
            exit 1
          fi
          
          echo "‚úÖ All paths verified, running benchmarks..."
          ./run-benchmarks.sh ${{ github.event.inputs.suite }}

      - name: Generate consolidated JSON
        run: |
          make json

      - name: Update GitHub Pages data
        run: |
          make update-gh-pages

      - name: Commit benchmark data
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
          git add docs/data/
          git diff --staged --quiet || git commit -m "ü§ñ Manual benchmark run: ${{ github.event.inputs.suite }} [skip ci]"
          git push || echo "No changes to commit"

      - name: Upload benchmark artifacts
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-${{ github.event.inputs.suite }}
          path: |
            results/benchmark-results-consolidated-*.json
            docs/data/benchmark-results-consolidated-latest.json

# Trigger workflow re-index
