name: Run Benchmarks

on:
  workflow_dispatch:  # Manual trigger
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  push:
    branches:
      - main
    paths:
      - 'scripts/**'
      - 'benches/**'
      - '.github/workflows/benchmarks.yml'

jobs:
  run-benchmarks:
    runs-on: [self-hosted, linux]  # Self-hosted runner required
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Setup dependencies (Core and Commons)
        run: |
          echo "Setting up Bitcoin Core and Bitcoin Commons..."
          
          # Setup Core
          if [ ! -d "$HOME/bitcoin-core" ]; then
            echo "Cloning Bitcoin Core..."
            git clone --depth 1 https://github.com/bitcoin/bitcoin.git "$HOME/bitcoin-core" || {
              echo "âš ï¸  Failed to clone Core, will try to use existing if available"
            }
          else
            echo "âœ… Bitcoin Core already exists at $HOME/bitcoin-core"
          fi
          
          # Setup Commons consensus
          if [ ! -d "$HOME/bllvm-consensus" ]; then
            echo "Cloning Bitcoin Commons (bllvm-consensus)..."
            git clone --depth 1 https://github.com/BTCDecoded/bllvm-consensus.git "$HOME/bllvm-consensus" || {
              echo "âš ï¸  Failed to clone bllvm-consensus, will try to use existing if available"
            }
          else
            echo "âœ… bllvm-consensus already exists at $HOME/bllvm-consensus"
          fi
          
          # Setup Commons node
          if [ ! -d "$HOME/bllvm-node" ]; then
            echo "Cloning Bitcoin Commons (bllvm-node)..."
            git clone --depth 1 https://github.com/BTCDecoded/bllvm-node.git "$HOME/bllvm-node" || {
              echo "âš ï¸  Failed to clone bllvm-node, will try to use existing if available"
            }
          else
            echo "âœ… bllvm-node already exists at $HOME/bllvm-node"
          fi
          
          # Create config.toml with absolute paths
          mkdir -p config
          cat > config/config.toml << EOF
          [paths]
          core_path = "$HOME/bitcoin-core"
          commons_consensus_path = "$HOME/bllvm-consensus"
          commons_node_path = "$HOME/bllvm-node"
          EOF
          echo "âœ… Created config/config.toml with paths"

      - name: Discover paths
        id: discover
        run: |
          source ./scripts/discover-paths.sh
          echo "core_path=$CORE_PATH" >> $GITHUB_OUTPUT
          echo "commons_consensus_path=$COMMONS_CONSENSUS_PATH" >> $GITHUB_OUTPUT
          echo "commons_node_path=$COMMONS_NODE_PATH" >> $GITHUB_OUTPUT
          echo "Discovered paths:"
          echo "  CORE_PATH: $CORE_PATH"
          echo "  COMMONS_CONSENSUS_PATH: $COMMONS_CONSENSUS_PATH"
          echo "  COMMONS_NODE_PATH: $COMMONS_NODE_PATH"

      - name: Check dependencies
        env:
          CORE_PATH: ${{ steps.discover.outputs.core_path }}
          COMMONS_CONSENSUS_PATH: ${{ steps.discover.outputs.commons_consensus_path }}
          COMMONS_NODE_PATH: ${{ steps.discover.outputs.commons_node_path }}
        run: |
          export CORE_PATH="$CORE_PATH"
          export COMMONS_CONSENSUS_PATH="$COMMONS_CONSENSUS_PATH"
          export COMMONS_NODE_PATH="$COMMONS_NODE_PATH"
          ./scripts/check-dependencies.sh
          if [ -z "$COMMONS_CONSENSUS_PATH" ]; then
            echo "âŒ COMMONS_CONSENSUS_PATH is still not set!"
            exit 1
          fi
          if [ ! -d "$COMMONS_CONSENSUS_PATH" ]; then
            echo "âŒ COMMONS_CONSENSUS_PATH directory does not exist: $COMMONS_CONSENSUS_PATH"
            exit 1
          fi
          echo "âœ… All dependencies found and validated"

      - name: Run benchmarks
        env:
          RUSTFLAGS: "-C target-cpu=native"
          CORE_PATH: ${{ steps.discover.outputs.core_path }}
          COMMONS_CONSENSUS_PATH: ${{ steps.discover.outputs.commons_consensus_path }}
          COMMONS_NODE_PATH: ${{ steps.discover.outputs.commons_node_path }}
        run: |
          export CORE_PATH="$CORE_PATH"
          export COMMONS_CONSENSUS_PATH="$COMMONS_CONSENSUS_PATH"
          export COMMONS_NODE_PATH="$COMMONS_NODE_PATH"
          make bench

      - name: Generate consolidated JSON
        run: |
          make json

      - name: Validate consolidated JSON
        run: |
          LATEST_JSON=$(find results -name "benchmark-results-consolidated-*.json" -type f | sort | tail -1)
          if [ -n "$LATEST_JSON" ]; then
            ./scripts/validate-benchmark.sh "$LATEST_JSON" || echo "âš ï¸  Validation warnings"
          fi

      - name: Track history
        run: |
          LATEST_JSON=$(find results -name "benchmark-results-consolidated-*.json" -type f | sort | tail -1)
          if [ -n "$LATEST_JSON" ]; then
            ./scripts/track-history.sh "$LATEST_JSON" || echo "âš ï¸  History tracking failed"
          fi

      - name: Detect regressions
        continue-on-error: true
        run: |
          LATEST_JSON=$(find results -name "benchmark-results-consolidated-*.json" -type f | sort | tail -1)
          if [ -n "$LATEST_JSON" ]; then
            ./scripts/detect-regressions.sh "$LATEST_JSON" || echo "âš ï¸  Regressions detected (see report)"
          fi

      - name: Find latest consolidated JSON
        id: find_json
        run: |
          LATEST_JSON=$(find results -name "benchmark-results-consolidated-*.json" -type f | sort | tail -1)
          if [ -z "$LATEST_JSON" ]; then
            echo "âŒ No consolidated JSON found"
            exit 1
          fi
          echo "json_file=$LATEST_JSON" >> $GITHUB_OUTPUT
          echo "Found: $LATEST_JSON"

      - name: Update GitHub Pages data
        run: |
          make update-gh-pages

      - name: Commit benchmark data
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
          git add docs/data/
          git diff --staged --quiet || git commit -m "ðŸ¤– Update benchmark data [skip ci]"
          git push || echo "No changes to commit"

      - name: Create Release (if on main)
        if: github.ref == 'refs/heads/main' && github.event_name == 'schedule'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: benchmarks-${{ github.run_number }}
          name: Benchmark Results ${{ github.run_number }}
          body: |
            Automated benchmark run from self-hosted runner.
            
            **Generated:** ${{ github.run_number }}
            **Commit:** ${{ github.sha }}
            
            Download the consolidated JSON from the assets below.
          files: |
            ${{ steps.find_json.outputs.json_file }}
            docs/data/benchmark-results-consolidated-latest.json
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}

      - name: Upload benchmark artifacts
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: |
            results/benchmark-results-consolidated-*.json
            docs/data/benchmark-results-consolidated-latest.json
          retention-days: 30

