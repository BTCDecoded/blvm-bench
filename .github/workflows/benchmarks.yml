name: Run Benchmarks (Parallel)

on:
  workflow_dispatch:  # Manual trigger
    inputs:
      speed_fast:
        description: 'Run fast benchmarks (< 2 min each)'
        required: false
        default: true
        type: boolean
      speed_medium:
        description: 'Run medium benchmarks (2-10 min each)'
        required: false
        default: false
        type: boolean
      speed_slow:
        description: 'Run slow benchmarks (> 10 min each)'
        required: false
        default: false
        type: boolean
      suite:
        description: 'Benchmark suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - fair
          - core
          - commons
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  push:
    branches:
      - main
    paths:
      - 'scripts/**'
      - 'benches/**'
      - '.github/workflows/benchmarks.yml'

jobs:
  # Setup job - clones repos and builds dependencies
  setup:
    runs-on: [self-hosted, Linux, X64, perf]
    outputs:
      core_path: ${{ steps.setup.outputs.core_path }}
      commons_consensus_path: ${{ steps.setup.outputs.commons_consensus_path }}
      commons_node_path: ${{ steps.setup.outputs.commons_node_path }}
      commons_protocol_path: ${{ steps.setup.outputs.commons_protocol_path }}
      suite: ${{ steps.determine_suite.outputs.suite }}
      speed: ${{ steps.determine_suite.outputs.speed }}
      speed_list: ${{ steps.determine_suite.outputs.speed_list }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          token: ${{ secrets.REPO_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Install system dependencies
        run: |
          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y libssl-dev pkg-config ccache tokei || echo "‚ö†Ô∏è  tokei not available via apt"
          elif command -v yum >/dev/null 2>&1; then
            sudo yum install -y openssl-devel pkgconfig ccache || echo "‚ö†Ô∏è  Some packages not available via yum"
          elif command -v dnf >/dev/null 2>&1; then
            sudo dnf install -y openssl-devel pkgconfig ccache tokei || echo "‚ö†Ô∏è  tokei not available via dnf"
          elif command -v pacman >/dev/null 2>&1; then
            sudo pacman -S --noconfirm openssl pkgconf ccache tokei || echo "‚ö†Ô∏è  tokei not available via pacman"
          elif command -v apk >/dev/null 2>&1; then
            sudo apk add openssl-dev pkgconfig ccache || echo "‚ö†Ô∏è  Some packages not available via apk"
          else
            echo "‚ö†Ô∏è  Unknown package manager, skipping system dependency installation"
          fi
          
          if ! command -v tokei >/dev/null 2>&1; then
            if command -v cargo >/dev/null 2>&1; then
              echo "Installing tokei via cargo..."
              cargo install tokei --locked || echo "‚ö†Ô∏è  Failed to install tokei via cargo"
            fi
          fi

      - name: Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Determine suite and speed
        id: determine_suite
        run: |
          # Parse speed checkboxes
          SPEED_FAST="${{ github.event.inputs.speed_fast }}"
          SPEED_MEDIUM="${{ github.event.inputs.speed_medium }}"
          SPEED_SLOW="${{ github.event.inputs.speed_slow }}"
          
          # Build speed list from checkboxes
          SPEED_LIST=""
          if [ "$SPEED_FAST" = "true" ]; then
            SPEED_LIST="${SPEED_LIST}fast "
          fi
          if [ "$SPEED_MEDIUM" = "true" ]; then
            SPEED_LIST="${SPEED_LIST}medium "
          fi
          if [ "$SPEED_SLOW" = "true" ]; then
            SPEED_LIST="${SPEED_LIST}slow "
          fi
          
          # Default to fast if nothing selected
          if [ -z "$SPEED_LIST" ]; then
            SPEED_LIST="fast "
            echo "‚ö†Ô∏è  No speed category selected, defaulting to fast"
          fi
          
          SPEED_LIST=$(echo "$SPEED_LIST" | xargs)  # Trim whitespace
          echo "üöÄ Selected speed categories: $SPEED_LIST"
          echo "speed_list=$SPEED_LIST" >> $GITHUB_OUTPUT
          
          # Get suite from dropdown (default: all)
          SUITE="${{ github.event.inputs.suite || 'all' }}"
          echo "üöÄ Running benchmark suite: $SUITE"
          echo "suite=$SUITE" >> $GITHUB_OUTPUT
          
          # For backward compatibility, determine primary speed
          # If only one speed selected, use it; otherwise use "all"
          SPEED_COUNT=$(echo "$SPEED_LIST" | wc -w)
          if [ "$SPEED_COUNT" -eq 1 ]; then
            PRIMARY_SPEED="$SPEED_LIST"
          else
            PRIMARY_SPEED="all"
          fi
          echo "speed=$PRIMARY_SPEED" >> $GITHUB_OUTPUT

      - name: Setup dependencies (Core and Commons)
        id: setup
        run: |
          echo "Setting up Bitcoin Core and Bitcoin Commons..."
          
          # Setup Core - improved detection using CoreBuilder patterns
          CORE_DIR=""
          CORE_FOUND=false
          
          # 1. Check CORE_PATH environment variable
          if [ -n "$CORE_PATH" ] && [ -d "$CORE_PATH" ]; then
            CORE_DIR="$CORE_PATH"
            CORE_FOUND=true
            echo "‚úÖ Using CORE_PATH: $CORE_DIR"
          # 2. Check cache directory (self-hosted runner optimization)
          elif [ -d "/opt/bitcoin-core/binaries/v25.0" ]; then
            CORE_DIR="/opt/bitcoin-core"
            CORE_FOUND=true
            echo "‚úÖ Using cached Core: $CORE_DIR"
          # 3. Check common build locations
          elif [ -d "$HOME/bitcoin" ]; then
            CORE_DIR="$HOME/bitcoin"
            CORE_FOUND=true
            echo "‚úÖ Found Core at: $CORE_DIR"
          elif [ -d "$HOME/src/bitcoin" ]; then
            CORE_DIR="$HOME/src/bitcoin"
            CORE_FOUND=true
            echo "‚úÖ Found Core at: $CORE_DIR"
          elif [ -d "$HOME/bitcoin-core" ]; then
            CORE_DIR="$HOME/bitcoin-core"
            CORE_FOUND=true
            echo "‚úÖ Found Core at: $CORE_DIR"
          elif [ -d "$HOME/src/bitcoin-core" ]; then
            CORE_DIR="$HOME/src/bitcoin-core"
            CORE_FOUND=true
            echo "‚úÖ Found Core at: $CORE_DIR"
          fi
          
          # If not found, try to clone
          if [ "$CORE_FOUND" = "false" ]; then
            CORE_DIR="$HOME/bitcoin-core"
            echo "Cloning Bitcoin Core..."
            git clone --depth 1 https://github.com/bitcoin/bitcoin.git "$CORE_DIR" || {
              echo "‚ö†Ô∏è  Failed to clone Core, trying existing directory..."
              if [ -d "$HOME/src/bitcoin" ]; then
                CORE_DIR="$HOME/src/bitcoin"
              elif [ -d "$HOME/src/bitcoin-core" ]; then
                CORE_DIR="$HOME/src/bitcoin-core"
              else
                echo "‚ùå Could not find or clone Bitcoin Core"
                exit 1
              fi
            }
          fi
          
          # Verify Core directory exists and has expected structure
          if [ ! -d "$CORE_DIR" ]; then
            echo "‚ùå Core directory does not exist: $CORE_DIR"
            exit 1
          fi
          
          # Check for source files (indicates it's a source directory, not binaries)
          if [ ! -f "$CORE_DIR/src/bitcoind.cpp" ] && [ ! -f "$CORE_DIR/CMakeLists.txt" ] && [ ! -f "$CORE_DIR/autogen.sh" ]; then
            echo "‚ö†Ô∏è  Warning: Core directory may not be a source directory"
            echo "   Expected: src/bitcoind.cpp, CMakeLists.txt, or autogen.sh"
          fi
          
          echo "core_path=$CORE_DIR" >> $GITHUB_OUTPUT
          echo "‚úÖ Core setup complete: $CORE_DIR"
          
          # Setup Commons consensus
          CONSENSUS_DIR="$HOME/bllvm-consensus"
          if [ ! -d "$CONSENSUS_DIR" ]; then
            echo "Cloning Bitcoin Commons consensus..."
            git clone --depth 1 https://github.com/BTCDecoded/bllvm-consensus.git "$CONSENSUS_DIR" || {
              echo "‚ö†Ô∏è  Failed to clone consensus, trying existing directory..."
              if [ -d "$HOME/src/bllvm-consensus" ]; then
                CONSENSUS_DIR="$HOME/src/bllvm-consensus"
              fi
            }
          fi
          echo "commons_consensus_path=$CONSENSUS_DIR" >> $GITHUB_OUTPUT
          
          # Setup Commons node
          NODE_DIR="$HOME/bllvm-node"
          if [ ! -d "$NODE_DIR" ]; then
            echo "Cloning Bitcoin Commons node..."
            git clone --depth 1 https://github.com/BTCDecoded/bllvm-node.git "$NODE_DIR" || {
              echo "‚ö†Ô∏è  Failed to clone node, trying existing directory..."
              if [ -d "$HOME/src/bllvm-node" ]; then
                NODE_DIR="$HOME/src/bllvm-node"
              fi
            }
          fi
          echo "commons_node_path=$NODE_DIR" >> $GITHUB_OUTPUT
          
          # Setup Commons protocol
          PROTOCOL_DIR="$HOME/bllvm-protocol"
          if [ ! -d "$PROTOCOL_DIR" ]; then
            echo "Cloning Bitcoin Commons protocol..."
            git clone --depth 1 https://github.com/BTCDecoded/bllvm-protocol.git "$PROTOCOL_DIR" || {
              echo "‚ö†Ô∏è  Failed to clone protocol, trying existing directory..."
              if [ -d "$HOME/src/bllvm-protocol" ]; then
                PROTOCOL_DIR="$HOME/src/bllvm-protocol"
              fi
            }
          fi
          echo "commons_protocol_path=$PROTOCOL_DIR" >> $GITHUB_OUTPUT
          
          # Create config.toml
          mkdir -p "$GITHUB_WORKSPACE/config"
          cat > "$GITHUB_WORKSPACE/config/config.toml" << EOF
          [core]
          path = "$CORE_DIR"
          
          [commons]
          consensus_path = "$CONSENSUS_DIR"
          node_path = "$NODE_DIR"
          protocol_path = "$PROTOCOL_DIR"
          EOF
          
          # Create symlinks for Commons dependencies
          cd "$GITHUB_WORKSPACE"
          RELATIVE_CONSENSUS_DIR="../bllvm-consensus"
          RELATIVE_NODE_DIR="../bllvm-node"
          RELATIVE_PROTOCOL_DIR="../bllvm-protocol"
          
          if [ ! -e "$RELATIVE_CONSENSUS_DIR" ]; then
            ln -sf "$(cd "$CONSENSUS_DIR" && pwd)" "$RELATIVE_CONSENSUS_DIR"
          fi
          if [ ! -e "$RELATIVE_NODE_DIR" ]; then
            ln -sf "$(cd "$NODE_DIR" && pwd)" "$RELATIVE_NODE_DIR"
          fi
          if [ ! -e "$RELATIVE_PROTOCOL_DIR" ] && [ -d "$HOME/bllvm-protocol" ]; then
            ln -sf "$(cd "$HOME/bllvm-protocol" && pwd)" "$RELATIVE_PROTOCOL_DIR"
          fi
          
          # Verify Cargo.toml can find dependencies
          if [ -f "Cargo.toml" ]; then
            echo "Verifying Cargo.toml dependencies..."
            if grep -q "bllvm-consensus" Cargo.toml; then
              echo "‚úÖ bllvm-consensus dependency found in Cargo.toml"
            fi
          fi

      - name: Verify Core with Rust infrastructure (optional check)
        run: |
          # Optional: Use Rust CoreBuilder to verify Core detection
          # This provides better diagnostics and matches differential test behavior
          # Note: This is optional and non-blocking - benchmarks don't require this
          cd "$GITHUB_WORKSPACE"
          
          echo "üîç Checking if Rust infrastructure is available (optional)..."
          
          # Verify dependencies are available
          if [ ! -e "../bllvm-consensus" ] && [ ! -d "../bllvm-consensus" ]; then
            echo "‚ö†Ô∏è  bllvm-consensus dependency not found, skipping Rust check"
            echo "‚ÑπÔ∏è  This is expected if dependencies aren't set up yet (not critical for benchmarks)"
            exit 0
          fi
          
          # Try to build with verbose output to see what's happening
          echo "Building bllvm-bench with benchmark-helpers feature..."
          if cargo build --features benchmark-helpers --bin bllvm-bench --message-format=short 2>&1; then
            echo "‚úÖ Rust infrastructure available for Core detection"
            # Could use: cargo run --features benchmark-helpers --bin bllvm-bench -- --find-core
          else
            echo "‚ÑπÔ∏è  Rust infrastructure check failed (not critical for benchmarks)"
            echo "   This is expected if dependencies aren't fully set up or if there are build issues"
            echo "   Benchmarks will continue using shell scripts which don't require this"
          fi
        continue-on-error: true

      - name: Build Bitcoin Core
        run: |
          CORE_PATH="${{ steps.setup.outputs.core_path }}"
          cd "$CORE_PATH"
          
          # Unset CC/CXX to prevent ccache interference with OpenSSL build scripts
          unset CC CXX
          
          # Try CMake first
          if [ ! -f "build/bin/bench_bitcoin" ] && [ ! -f "src/bench_bitcoin" ]; then
            echo "Building bench_bitcoin with CMake..."
            mkdir -p build
            cd build
            
            CMAKE_ARGS=(-DCMAKE_BUILD_TYPE=Release -DBUILD_BENCH=ON -DENABLE_IPC=OFF)
            
            # Handle ccache
            if command -v ccache >/dev/null 2>&1; then
              CMAKE_ARGS+=(-DCMAKE_CXX_COMPILER_LAUNCHER="ccache")
              CMAKE_ARGS+=(-DCMAKE_C_COMPILER_LAUNCHER="ccache")
            fi
            
            if ! cmake "${CMAKE_ARGS[@]}" .. 2>&1 | tee /tmp/cmake-configure.log; then
              echo "‚ö†Ô∏è  CMake configure failed, trying autotools..."
              cd ..
              if [ -f "autogen.sh" ]; then
                ./autogen.sh || exit 1
                ./configure --enable-bench --disable-wallet --disable-gui || exit 1
                make -j$(nproc) bench_bitcoin || exit 1
              else
                exit 1
              fi
            else
              cmake --build . --target bench_bitcoin -j$(nproc) || {
                echo "‚ö†Ô∏è  CMake build failed, trying autotools..."
                cd ..
                if [ -f "autogen.sh" ]; then
                  ./autogen.sh || exit 1
                  ./configure --enable-bench --disable-wallet --disable-gui || exit 1
                  make -j$(nproc) bench_bitcoin || exit 1
                else
                  exit 1
                fi
              }
            fi
          fi
          
          # Verify bench_bitcoin exists
          if [ -f "build/bin/bench_bitcoin" ] || [ -f "src/bench_bitcoin" ]; then
            echo "‚úÖ bench_bitcoin ready"
          else
            echo "‚ùå bench_bitcoin not found"
            exit 1
          fi

  # Generate benchmark matrix
  generate-matrix:
    needs: setup
    runs-on: [self-hosted, Linux, X64, perf]
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate benchmark matrix
        id: set-matrix
        run: |
          SUITE="${{ needs.setup.outputs.suite }}"
          SPEED_LIST="${{ needs.setup.outputs.speed_list }}"
          SPEED="${{ needs.setup.outputs.speed }}"
          BENCHMARKS=()
          
          # Source speed mapping
          source "$GITHUB_WORKSPACE/scripts/benchmark-speed-map.sh"
          
          # If speed list is provided (multiple speeds selected), filter by all selected speeds
          if [ -n "$SPEED_LIST" ] && [ "$SPEED" != "all" ]; then
            echo "Filtering benchmarks by speed categories: $SPEED_LIST"
            
            # Collect benchmarks from all selected speed categories
            ALL_SPEED_BENCHMARKS=""
            for speed_cat in $SPEED_LIST; do
              echo "Getting benchmarks for speed category: $speed_cat"
              SPEED_BENCHMARKS=$(get_benchmarks_by_speed "$speed_cat")
              if [ -n "$SPEED_BENCHMARKS" ]; then
                ALL_SPEED_BENCHMARKS="${ALL_SPEED_BENCHMARKS}${SPEED_BENCHMARKS} "
              fi
            done
            
            # Remove duplicates and set
            SPEED_BENCHMARKS=$(echo "$ALL_SPEED_BENCHMARKS" | tr ' ' '\n' | sort -u | tr '\n' ' ' | xargs)
            
            # Find matching scripts
            if [ -d "scripts/shared/benchmarks" ]; then
              for bench in $SPEED_BENCHMARKS; do
                for script in scripts/shared/benchmarks/*.sh; do
                  if [ -f "$script" ]; then
                    name=$(basename "$script" .sh)
                    if [ "$name" = "$bench" ]; then
                      BENCHMARKS+=("{\"name\":\"$name\",\"script\":\"$script\",\"type\":\"shared\"}")
                    fi
                  fi
                done
              done
            fi
            
            if [ -d "scripts/core" ]; then
              for bench in $SPEED_BENCHMARKS; do
                for script in scripts/core/*.sh; do
                  if [ -f "$script" ]; then
                    name=$(basename "$script" .sh)
                    if [ "$name" = "$bench" ]; then
                      BENCHMARKS+=("{\"name\":\"core-$name\",\"script\":\"$script\",\"type\":\"core\"}")
                    fi
                  fi
                done
              done
            fi
            
            if [ -d "scripts/commons" ]; then
              for bench in $SPEED_BENCHMARKS; do
                for script in scripts/commons/*.sh; do
                  if [ -f "$script" ]; then
                    name=$(basename "$script" .sh)
                    if [ "$name" = "$bench" ]; then
                      BENCHMARKS+=("{\"name\":\"commons-$name\",\"script\":\"$script\",\"type\":\"commons\"}")
                    fi
                  fi
                done
              done
            fi
          # Handle suite selection (can be multiple or "all")
          elif [ "$SUITE" = "all" ]; then
            # All benchmarks
            if [ -d "scripts/shared/benchmarks" ]; then
              for script in scripts/shared/benchmarks/*.sh; do
                if [ -f "$script" ]; then
                  name=$(basename "$script" .sh)
                  BENCHMARKS+=("{\"name\":\"$name\",\"script\":\"$script\",\"type\":\"shared\"}")
                fi
              done
            fi
            if [ -d "scripts/core" ]; then
              for script in scripts/core/*.sh; do
                if [ -f "$script" ]; then
                  name=$(basename "$script" .sh)
                  BENCHMARKS+=("{\"name\":\"core-$name\",\"script\":\"$script\",\"type\":\"core\"}")
                fi
              done
            fi
            if [ -d "scripts/commons" ]; then
              for script in scripts/commons/*.sh; do
                if [ -f "$script" ]; then
                  name=$(basename "$script" .sh)
                  BENCHMARKS+=("{\"name\":\"commons-$name\",\"script\":\"$script\",\"type\":\"commons\"}")
                fi
              done
            fi
          elif [ "$SUITE" = "fair" ]; then
            # Fair comparison benchmarks only
            BENCHMARKS+=("{\"name\":\"core-block-validation-bench\",\"script\":\"scripts/core/block-validation-bench.sh\",\"type\":\"core\"}")
            BENCHMARKS+=("{\"name\":\"commons-block-validation-bench\",\"script\":\"scripts/commons/block-validation-bench.sh\",\"type\":\"commons\"}")
            BENCHMARKS+=("{\"name\":\"core-transaction-validation-bench\",\"script\":\"scripts/core/transaction-validation-bench.sh\",\"type\":\"core\"}")
            BENCHMARKS+=("{\"name\":\"commons-transaction-validation-bench\",\"script\":\"scripts/commons/transaction-validation-bench.sh\",\"type\":\"commons\"}")
            BENCHMARKS+=("{\"name\":\"core-mempool-operations-bench\",\"script\":\"scripts/core/mempool-operations-bench.sh\",\"type\":\"core\"}")
            BENCHMARKS+=("{\"name\":\"commons-mempool-operations-bench\",\"script\":\"scripts/commons/mempool-operations-bench.sh\",\"type\":\"commons\"}")
          elif [ "$SUITE" = "core" ]; then
            # Core-only benchmarks
            if [ -d "scripts/core" ]; then
              for script in scripts/core/*.sh; do
                if [ -f "$script" ]; then
                  name=$(basename "$script" .sh)
                  BENCHMARKS+=("{\"name\":\"core-$name\",\"script\":\"$script\",\"type\":\"core\"}")
                fi
              done
            fi
          elif [ "$SUITE" = "commons" ]; then
            # Commons-only benchmarks
            if [ -d "scripts/commons" ]; then
              for script in scripts/commons/*.sh; do
                if [ -f "$script" ]; then
                  name=$(basename "$script" .sh)
                  BENCHMARKS+=("{\"name\":\"commons-$name\",\"script\":\"$script\",\"type\":\"commons\"}")
                fi
              done
            fi
          fi
          
          # Create matrix JSON array
          if [ ${#BENCHMARKS[@]} -eq 0 ]; then
            echo "‚ö†Ô∏è  No benchmarks found for suite: $SUITE"
            echo "matrix=[]" >> $GITHUB_OUTPUT
          else
            MATRIX_JSON="[$(IFS=,; echo "${BENCHMARKS[*]}")]"
            echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
            echo "Generated matrix with ${#BENCHMARKS[@]} benchmarks:"
            echo "$MATRIX_JSON" | jq '.' || echo "$MATRIX_JSON"
          fi

  # Run benchmarks in parallel
  run-benchmark:
    needs: [setup, generate-matrix]
    runs-on: [self-hosted, Linux, X64, perf]
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Setup Commons dependencies
        run: |
          COMMONS_CONSENSUS_PATH="${{ needs.setup.outputs.commons_consensus_path }}"
          COMMONS_NODE_PATH="${{ needs.setup.outputs.commons_node_path }}"
          COMMONS_PROTOCOL_PATH="${{ needs.setup.outputs.commons_protocol_path }}"
          
          # Create symlinks for Commons dependencies (use absolute paths)
          cd "$GITHUB_WORKSPACE"
          if [ ! -e "../bllvm-consensus" ]; then
            ln -sf "$COMMONS_CONSENSUS_PATH" ../bllvm-consensus
            echo "‚úÖ Created symlink: ../bllvm-consensus -> $COMMONS_CONSENSUS_PATH"
          fi
          if [ ! -e "../bllvm-node" ]; then
            ln -sf "$COMMONS_NODE_PATH" ../bllvm-node
            echo "‚úÖ Created symlink: ../bllvm-node -> $COMMONS_NODE_PATH"
          fi
          if [ ! -e "../bllvm-protocol" ] && [ -d "$COMMONS_PROTOCOL_PATH" ]; then
            ln -sf "$COMMONS_PROTOCOL_PATH" ../bllvm-protocol
            echo "‚úÖ Created symlink: ../bllvm-protocol -> $COMMONS_PROTOCOL_PATH"
          fi
          
          # Verify symlinks
          echo "Verifying dependencies..."
          if [ -f "../bllvm-consensus/Cargo.toml" ]; then
            echo "‚úÖ bllvm-consensus found"
          else
            echo "‚ùå bllvm-consensus not found at ../bllvm-consensus/Cargo.toml"
            ls -la ../bllvm-consensus 2>/dev/null || echo "   Symlink doesn't exist"
          fi
          if [ -f "../bllvm-node/Cargo.toml" ]; then
            echo "‚úÖ bllvm-node found"
          else
            echo "‚ùå bllvm-node not found at ../bllvm-node/Cargo.toml"
            ls -la ../bllvm-node 2>/dev/null || echo "   Symlink doesn't exist"
          fi
          if [ -f "../bllvm-protocol/Cargo.toml" ]; then
            echo "‚úÖ bllvm-protocol found"
          else
            echo "‚ùå bllvm-protocol not found at ../bllvm-protocol/Cargo.toml"
            ls -la ../bllvm-protocol 2>/dev/null || echo "   Symlink doesn't exist"
            echo "   Expected path: $COMMONS_PROTOCOL_PATH"
          fi

      - name: Verify paths and set environment
        run: |
          CORE_PATH="${{ needs.setup.outputs.core_path }}"
          COMMONS_CONSENSUS_PATH="${{ needs.setup.outputs.commons_consensus_path }}"
          COMMONS_NODE_PATH="${{ needs.setup.outputs.commons_node_path }}"
          PROTOCOL_DIR="$HOME/bllvm-protocol"
          
          # Verify Core path and bench_bitcoin (improved detection)
          echo "Checking Core setup..."
          echo "CORE_PATH: $CORE_PATH"
          
          BENCH_BITCOIN_FOUND=false
          BENCH_BITCOIN_PATH=""
          
          # Check multiple possible locations for bench_bitcoin
          if [ -f "$CORE_PATH/build/bin/bench_bitcoin" ]; then
            BENCH_BITCOIN_PATH="$CORE_PATH/build/bin/bench_bitcoin"
            BENCH_BITCOIN_FOUND=true
          elif [ -f "$CORE_PATH/src/bench_bitcoin" ]; then
            BENCH_BITCOIN_PATH="$CORE_PATH/src/bench_bitcoin"
            BENCH_BITCOIN_FOUND=true
          elif [ -f "$CORE_PATH/build/bench_bitcoin" ]; then
            BENCH_BITCOIN_PATH="$CORE_PATH/build/bench_bitcoin"
            BENCH_BITCOIN_FOUND=true
          fi
          
          if [ "$BENCH_BITCOIN_FOUND" = "true" ]; then
            echo "‚úÖ bench_bitcoin found at: $BENCH_BITCOIN_PATH"
            echo "BENCH_BITCOIN_PATH=$BENCH_BITCOIN_PATH" >> $GITHUB_ENV
          else
            echo "‚ö†Ô∏è  bench_bitcoin not found at expected paths"
            echo "   Checked:"
            echo "     - $CORE_PATH/build/bin/bench_bitcoin"
            echo "     - $CORE_PATH/src/bench_bitcoin"
            echo "     - $CORE_PATH/build/bench_bitcoin"
            echo "   Will attempt to build if needed"
          fi
          
          # Verify Commons dependencies
          echo "Verifying Commons dependencies..."
          if [ -f "$COMMONS_CONSENSUS_PATH/Cargo.toml" ]; then
            echo "‚úÖ bllvm-consensus found"
          else
            echo "‚ùå bllvm-consensus not found at: $COMMONS_CONSENSUS_PATH"
            exit 1
          fi
          
          if [ -f "$COMMONS_NODE_PATH/Cargo.toml" ]; then
            echo "‚úÖ bllvm-node found"
          else
            echo "‚ùå bllvm-node not found at: $COMMONS_NODE_PATH"
            exit 1
          fi
          
          # Export environment variables (make them available to all subsequent steps)
          echo "CORE_PATH=$CORE_PATH" >> $GITHUB_ENV
          echo "COMMONS_CONSENSUS_PATH=$COMMONS_CONSENSUS_PATH" >> $GITHUB_ENV
          echo "COMMONS_NODE_PATH=$COMMONS_NODE_PATH" >> $GITHUB_ENV
          echo "COMMONS_PROTOCOL_PATH=$PROTOCOL_DIR" >> $GITHUB_ENV
          
          # Also export for current step
          export CORE_PATH
          export COMMONS_CONSENSUS_PATH
          export COMMONS_NODE_PATH
          export COMMONS_PROTOCOL_PATH="$PROTOCOL_DIR"
          
          # Create config.toml
          mkdir -p config
          cat > config/config.toml << EOF
          [core]
          path = "$CORE_PATH"
          
          [commons]
          consensus_path = "$COMMONS_CONSENSUS_PATH"
          node_path = "$COMMONS_NODE_PATH"
          protocol_path = "$COMMONS_PROTOCOL_PATH"
          EOF
          
          echo "‚úÖ Config created at config/config.toml"

      - name: Run benchmark
        id: run
        env:
          CORE_PATH: ${{ needs.setup.outputs.core_path }}
          COMMONS_CONSENSUS_PATH: ${{ needs.setup.outputs.commons_consensus_path }}
          COMMONS_NODE_PATH: ${{ needs.setup.outputs.commons_node_path }}
          COMMONS_PROTOCOL_PATH: ${{ needs.setup.outputs.commons_protocol_path }}
        run: |
          # Ensure environment variables are set and exported
          export CORE_PATH="${CORE_PATH:-${{ needs.setup.outputs.core_path }}}"
          export COMMONS_CONSENSUS_PATH="${COMMONS_CONSENSUS_PATH:-${{ needs.setup.outputs.commons_consensus_path }}}"
          export COMMONS_NODE_PATH="${COMMONS_NODE_PATH:-${{ needs.setup.outputs.commons_node_path }}}"
          export COMMONS_PROTOCOL_PATH="${COMMONS_PROTOCOL_PATH:-${{ needs.setup.outputs.commons_protocol_path }}}"
          
          # Export to GITHUB_ENV so they're available to the script
          echo "CORE_PATH=$CORE_PATH" >> $GITHUB_ENV
          echo "COMMONS_CONSENSUS_PATH=$COMMONS_CONSENSUS_PATH" >> $GITHUB_ENV
          echo "COMMONS_NODE_PATH=$COMMONS_NODE_PATH" >> $GITHUB_ENV
          echo "COMMONS_PROTOCOL_PATH=$COMMONS_PROTOCOL_PATH" >> $GITHUB_ENV
          
          echo "Environment variables:"
          echo "  CORE_PATH: $CORE_PATH"
          echo "  COMMONS_CONSENSUS_PATH: $COMMONS_CONSENSUS_PATH"
          echo "  COMMONS_NODE_PATH: $COMMONS_NODE_PATH"
          echo "  COMMONS_PROTOCOL_PATH: $COMMONS_PROTOCOL_PATH"
          
          # Verify Core bench_bitcoin exists (using improved detection)
          BENCH_BITCOIN_FOUND=false
          if [ -f "$CORE_PATH/build/bin/bench_bitcoin" ]; then
            echo "‚úÖ bench_bitcoin found: $CORE_PATH/build/bin/bench_bitcoin"
            BENCH_BITCOIN_FOUND=true
          elif [ -f "$CORE_PATH/src/bench_bitcoin" ]; then
            echo "‚úÖ bench_bitcoin found: $CORE_PATH/src/bench_bitcoin"
            BENCH_BITCOIN_FOUND=true
          elif [ -f "$CORE_PATH/build/bench_bitcoin" ]; then
            echo "‚úÖ bench_bitcoin found: $CORE_PATH/build/bench_bitcoin"
            BENCH_BITCOIN_FOUND=true
          else
            echo "‚ö†Ô∏è  bench_bitcoin not found at expected paths"
            echo "   Checked:"
            echo "     - $CORE_PATH/build/bin/bench_bitcoin"
            echo "     - $CORE_PATH/src/bench_bitcoin"
            echo "     - $CORE_PATH/build/bench_bitcoin"
            echo "   Some benchmarks may fail if bench_bitcoin is required"
          fi
          
          # Export bench_bitcoin path if found
          if [ "$BENCH_BITCOIN_FOUND" = "true" ]; then
            if [ -f "$CORE_PATH/build/bin/bench_bitcoin" ]; then
              echo "BENCH_BITCOIN_PATH=$CORE_PATH/build/bin/bench_bitcoin" >> $GITHUB_ENV
            elif [ -f "$CORE_PATH/src/bench_bitcoin" ]; then
              echo "BENCH_BITCOIN_PATH=$CORE_PATH/src/bench_bitcoin" >> $GITHUB_ENV
            elif [ -f "$CORE_PATH/build/bench_bitcoin" ]; then
              echo "BENCH_BITCOIN_PATH=$CORE_PATH/build/bench_bitcoin" >> $GITHUB_ENV
            fi
          fi
          
          # Create results directory
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          RESULTS_DIR="results/suite-${{ needs.setup.outputs.suite }}-$TIMESTAMP"
          mkdir -p "$RESULTS_DIR"
          
          BENCH_NAME="${{ matrix.name }}"
          BENCH_SCRIPT="${{ matrix.script }}"
          
          echo "Running: $BENCH_NAME"
          echo "Script: $BENCH_SCRIPT"
          
          # Unset CC/CXX for Rust builds to prevent ccache interference
          unset CC CXX
          
          # Run benchmark with timeout
          if timeout 600 bash "$BENCH_SCRIPT" "$RESULTS_DIR" 2>&1 | tee "$RESULTS_DIR/${BENCH_NAME}.log"; then
            echo "‚úÖ $BENCH_NAME completed"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            EXIT_CODE=$?
            if [ $EXIT_CODE -eq 124 ]; then
              echo "‚è±Ô∏è  $BENCH_NAME timed out"
              echo "status=timeout" >> $GITHUB_OUTPUT
            else
              echo "‚ùå $BENCH_NAME failed (exit code: $EXIT_CODE)"
              echo "status=failed" >> $GITHUB_OUTPUT
            fi
          fi
          
          echo "results_dir=$RESULTS_DIR" >> $GITHUB_OUTPUT

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: benchmark-${{ matrix.name }}
          path: |
            ${{ steps.run.outputs.results_dir }}/**/*.json
            ${{ steps.run.outputs.results_dir }}/**/*.log
          retention-days: 7

  # Consolidate all benchmark results
  consolidate:
    needs: [setup, generate-matrix, run-benchmark]
    runs-on: [self-hosted, Linux, X64, perf]
    if: always()
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          token: ${{ secrets.REPO_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Download all benchmark artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Consolidate JSON files
        id: consolidate
        run: |
          SUITE="${{ needs.setup.outputs.suite }}"
          SPEED="${{ needs.setup.outputs.speed }}"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          RESULTS_DIR="results/suite-$SUITE-$TIMESTAMP"
          mkdir -p "$RESULTS_DIR"
          
          echo "Collecting JSON files from artifacts..."
          # Collect all JSON files from artifacts (they're in subdirectories)
          JSON_COUNT=0
          for json_file in $(find artifacts -name "*.json" -type f); do
            cp "$json_file" "$RESULTS_DIR/" 2>/dev/null || true
            JSON_COUNT=$((JSON_COUNT + 1))
          done
          echo "Collected $JSON_COUNT JSON files"
          
          # Also collect metrics JSON files if they exist
          for metrics_file in $(find artifacts -name "*metrics*.json" -type f); do
            cp "$metrics_file" "$RESULTS_DIR/" 2>/dev/null || true
          done
          
          # Run consolidation script
          if [ -f "scripts/generate-consolidated-json.sh" ]; then
            echo "Running consolidation script..."
            
            # If speed is specified (fast/medium/slow), generate only that category
            if [ "$SPEED" != "all" ] && [ "$SPEED" != "fair" ] && [ "$SPEED" != "core" ] && [ "$SPEED" != "commons" ]; then
              echo "Generating $SPEED benchmarks JSON..."
              bash scripts/generate-consolidated-json.sh "$RESULTS_DIR" "$SPEED" || {
                echo "‚ö†Ô∏è  Consolidation script failed for $SPEED, but continuing..."
              }
              
              # Set output for the specific speed
              case "$SPEED" in
                fast)
                  FAST_JSON="$RESULTS_DIR/benchmark-results-fast.json"
                  echo "json_file_fast=$FAST_JSON" >> $GITHUB_OUTPUT
                  echo "json_file=$FAST_JSON" >> $GITHUB_OUTPUT
                  ;;
                medium)
                  MEDIUM_JSON="$RESULTS_DIR/benchmark-results-medium.json"
                  echo "json_file_medium=$MEDIUM_JSON" >> $GITHUB_OUTPUT
                  echo "json_file=$MEDIUM_JSON" >> $GITHUB_OUTPUT
                  ;;
                slow)
                  SLOW_JSON="$RESULTS_DIR/benchmark-results-slow.json"
                  echo "json_file_slow=$SLOW_JSON" >> $GITHUB_OUTPUT
                  echo "json_file=$SLOW_JSON" >> $GITHUB_OUTPUT
                  ;;
              esac
            else
              # ALWAYS generate all three speed categories (for scheduled/push or "all" option)
              # This ensures we always have 3 separate JSON files
              echo "Generating all speed category JSONs (fast, medium, slow)..."
              for speed_cat in fast medium slow; do
                echo "Generating $speed_cat benchmarks JSON..."
                bash scripts/generate-consolidated-json.sh "$RESULTS_DIR" "$speed_cat" || {
                  echo "‚ö†Ô∏è  Consolidation script failed for $speed_cat, but continuing..."
                }
              done
              
              # Set outputs for all three - these will always be set
              FAST_JSON="$RESULTS_DIR/benchmark-results-fast.json"
              MEDIUM_JSON="$RESULTS_DIR/benchmark-results-medium.json"
              SLOW_JSON="$RESULTS_DIR/benchmark-results-slow.json"
              
              # Always set all three outputs, even if files are empty
              echo "json_file_fast=$FAST_JSON" >> $GITHUB_OUTPUT
              echo "json_file_medium=$MEDIUM_JSON" >> $GITHUB_OUTPUT
              echo "json_file_slow=$SLOW_JSON" >> $GITHUB_OUTPUT
              
              # Also generate legacy consolidated JSON for backward compatibility
              bash scripts/generate-consolidated-json.sh "$RESULTS_DIR" || {
                echo "‚ö†Ô∏è  Consolidation script failed, but continuing..."
              }
              CONSOLIDATED_JSON="$RESULTS_DIR/benchmark-results-consolidated-latest.json"
              echo "json_file=$CONSOLIDATED_JSON" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ö†Ô∏è  Consolidation script not found"
          fi
          
          # Validate JSONs have content
          for json_file in "$FAST_JSON" "$MEDIUM_JSON" "$SLOW_JSON" "$CONSOLIDATED_JSON"; do
            if [ -n "$json_file" ] && [ -f "$json_file" ]; then
              if [ -s "$json_file" ]; then
                echo "‚úÖ $(basename "$json_file") has content ($(wc -c < "$json_file") bytes)"
              else
                echo "‚ö†Ô∏è  $(basename "$json_file") is empty"
              fi
            fi
          done
          
          # Collect metrics if suite is 'all' or speed is 'all'
          if [ "$SUITE" = "all" ] || [ "$SPEED" = "all" ]; then
            echo "Collecting codebase metrics..."
            export COLLECT_METRICS=true
            if [ -f "scripts/metrics/code-size.sh" ]; then
              bash scripts/metrics/code-size.sh "$RESULTS_DIR" || true
            fi
            if [ -f "scripts/metrics/features.sh" ]; then
              bash scripts/metrics/features.sh "$RESULTS_DIR" || true
            fi
            if [ -f "scripts/metrics/tests.sh" ]; then
              bash scripts/metrics/tests.sh "$RESULTS_DIR" || true
            fi
            if [ -f "scripts/metrics/combined-view.sh" ]; then
              bash scripts/metrics/combined-view.sh "$RESULTS_DIR" || true
            fi
            if [ -f "scripts/metrics/full-view.sh" ]; then
              bash scripts/metrics/full-view.sh "$RESULTS_DIR" || true
            fi
          fi

      - name: Run differential tests and generate JSON
        id: run_differential
        if: success()
        run: |
          echo "Running differential tests..."
          export CORE_PATH="${{ needs.setup.outputs.core_path }}"
          export BITCOIN_RPC_USER=test
          export BITCOIN_RPC_PASSWORD=test
          export BITCOIN_NETWORK=regtest
          
          # Ensure results directory exists
          mkdir -p results
          
          # Run tests and generate JSON
          cargo test --features differential --test integration -- --nocapture || true
          
          # Ensure JSON is written (test may not have run due to execution order)
          # Try to write it explicitly if it doesn't exist
          if [ ! -f "results/differential-test-results.json" ]; then
            echo "‚ö†Ô∏è  Differential test JSON not found after tests, attempting to generate..."
            # Run the JSON writing test explicitly
            cargo test --features differential --test integration z_write_differential_test_results -- --nocapture || true
          fi
          
          # Check for JSON file
          if [ -f "results/differential-test-results.json" ]; then
            echo "‚úÖ Differential test JSON found"
            echo "differential_json=results/differential-test-results.json" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è  Differential test JSON not found after all attempts"
            echo "differential_json=" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Create or Update Release
        if: success() && (steps.consolidate.outputs.json_file != '' || steps.consolidate.outputs.json_file_fast != '')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: benchmarks-latest
          name: Latest Benchmark & Differential Test Results
          body: |
            Latest benchmark and differential test results.
            
            Suite: ${{ needs.setup.outputs.suite }}
            Speed: ${{ needs.setup.outputs.speed }}
            Generated: $(date -u +%Y-%m-%dT%H:%M:%SZ)
            
            ## Files Included:
            ${{ steps.consolidate.outputs.json_file_fast && '‚úÖ Fast benchmarks' || '' }}
            ${{ steps.consolidate.outputs.json_file_medium && '‚úÖ Medium benchmarks' || '' }}
            ${{ steps.consolidate.outputs.json_file_slow && '‚úÖ Slow benchmarks' || '' }}
            ${{ steps.run_differential.outputs.differential_json && '‚úÖ Differential test results' || '' }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Delete old release assets
        if: success()
        run: |
          gh release delete-asset benchmarks-latest benchmark-results-consolidated-latest.json --yes || true
          gh release delete-asset benchmarks-latest benchmark-results-fast.json --yes || true
          gh release delete-asset benchmarks-latest benchmark-results-medium.json --yes || true
          gh release delete-asset benchmarks-latest benchmark-results-slow.json --yes || true
          gh release delete-asset benchmarks-latest differential-test-results.json --yes || true
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Upload JSON files to release
        if: success()
        run: |
          echo "Uploading JSON files to release..."
          
          # Upload all 3 speed category JSON files (always upload if they exist)
          # Fast benchmarks
          if [ -n "${{ steps.consolidate.outputs.json_file_fast }}" ] && [ -f "${{ steps.consolidate.outputs.json_file_fast }}" ]; then
            echo "üì§ Uploading fast benchmarks: ${{ steps.consolidate.outputs.json_file_fast }}"
            gh release upload benchmarks-latest "${{ steps.consolidate.outputs.json_file_fast }}" --clobber || echo "‚ö†Ô∏è  Failed to upload fast benchmarks"
          else
            echo "‚ö†Ô∏è  Fast benchmarks JSON not found, skipping upload"
          fi
          
          # Medium benchmarks
          if [ -n "${{ steps.consolidate.outputs.json_file_medium }}" ] && [ -f "${{ steps.consolidate.outputs.json_file_medium }}" ]; then
            echo "üì§ Uploading medium benchmarks: ${{ steps.consolidate.outputs.json_file_medium }}"
            gh release upload benchmarks-latest "${{ steps.consolidate.outputs.json_file_medium }}" --clobber || echo "‚ö†Ô∏è  Failed to upload medium benchmarks"
          else
            echo "‚ö†Ô∏è  Medium benchmarks JSON not found, skipping upload"
          fi
          
          # Slow benchmarks
          if [ -n "${{ steps.consolidate.outputs.json_file_slow }}" ] && [ -f "${{ steps.consolidate.outputs.json_file_slow }}" ]; then
            echo "üì§ Uploading slow benchmarks: ${{ steps.consolidate.outputs.json_file_slow }}"
            gh release upload benchmarks-latest "${{ steps.consolidate.outputs.json_file_slow }}" --clobber || echo "‚ö†Ô∏è  Failed to upload slow benchmarks"
          else
            echo "‚ö†Ô∏è  Slow benchmarks JSON not found, skipping upload"
          fi
          
          # Differential test results
          if [ -n "${{ steps.run_differential.outputs.differential_json }}" ] && [ -f "${{ steps.run_differential.outputs.differential_json }}" ]; then
            echo "üì§ Uploading differential test results: ${{ steps.run_differential.outputs.differential_json }}"
            gh release upload benchmarks-latest "${{ steps.run_differential.outputs.differential_json }}" --clobber || echo "‚ö†Ô∏è  Failed to upload differential test results"
          else
            echo "‚ö†Ô∏è  Differential test JSON not found, skipping upload"
          fi
          
          echo "‚úÖ Upload complete"
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
