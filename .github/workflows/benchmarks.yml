name: Run Benchmarks

on:
  workflow_dispatch:  # Manual trigger
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  push:
    branches:
      - main
    paths:
      - 'scripts/**'
      - 'benches/**'
      - '.github/workflows/benchmarks.yml'

jobs:
  run-benchmarks:
    runs-on: [self-hosted, linux]  # Self-hosted runner required
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Setup dependencies (Core and Commons)
        id: setup
        run: |
          echo "Setting up Bitcoin Core and Bitcoin Commons..."
          
          # Setup Core
          CORE_DIR="$HOME/bitcoin-core"
          if [ ! -d "$CORE_DIR" ]; then
            echo "Cloning Bitcoin Core to $CORE_DIR..."
            git clone --depth 1 https://github.com/bitcoin/bitcoin.git "$CORE_DIR" || {
              echo "âŒ Failed to clone Core"
              exit 1
            }
          else
            echo "âœ… Bitcoin Core already exists at $CORE_DIR"
          fi
          
          # Setup Commons consensus
          # Clone to both $HOME (for path discovery) and relative to bllvm-bench (for Cargo.toml)
          CONSENSUS_DIR="$HOME/bllvm-consensus"
          BENCH_ROOT="$(pwd)"
          RELATIVE_CONSENSUS_DIR="$BENCH_ROOT/../bllvm-consensus"
          
          if [ ! -d "$CONSENSUS_DIR" ]; then
            echo "Cloning Bitcoin Commons (bllvm-consensus) to $CONSENSUS_DIR..."
            git clone --depth 1 https://github.com/BTCDecoded/bllvm-consensus.git "$CONSENSUS_DIR" || {
              echo "âŒ Failed to clone bllvm-consensus"
              exit 1
            }
          else
            echo "âœ… bllvm-consensus already exists at $CONSENSUS_DIR"
          fi
          
          # Also create symlink or copy for Cargo.toml path dependency
          if [ ! -d "$RELATIVE_CONSENSUS_DIR" ]; then
            echo "Creating symlink for Cargo.toml path dependency..."
            mkdir -p "$(dirname "$RELATIVE_CONSENSUS_DIR")"
            ln -s "$CONSENSUS_DIR" "$RELATIVE_CONSENSUS_DIR" || {
              echo "âš ï¸  Symlink failed, trying copy..."
              cp -r "$CONSENSUS_DIR" "$RELATIVE_CONSENSUS_DIR" || echo "âš ï¸  Copy also failed"
            }
          fi
          
          # Setup Commons node
          NODE_DIR="$HOME/bllvm-node"
          RELATIVE_NODE_DIR="$BENCH_ROOT/../bllvm-node"
          
          if [ ! -d "$NODE_DIR" ]; then
            echo "Cloning Bitcoin Commons (bllvm-node) to $NODE_DIR..."
            git clone --depth 1 https://github.com/BTCDecoded/bllvm-node.git "$NODE_DIR" || {
              echo "âŒ Failed to clone bllvm-node"
              exit 1
            }
          else
            echo "âœ… bllvm-node already exists at $NODE_DIR"
          fi
          
          # Also create symlink for Cargo.toml path dependency
          if [ ! -d "$RELATIVE_NODE_DIR" ]; then
            echo "Creating symlink for Cargo.toml path dependency..."
            mkdir -p "$(dirname "$RELATIVE_NODE_DIR")"
            ln -s "$NODE_DIR" "$RELATIVE_NODE_DIR" || {
              echo "âš ï¸  Symlink failed, trying copy..."
              cp -r "$NODE_DIR" "$RELATIVE_NODE_DIR" || echo "âš ï¸  Copy also failed"
            }
          fi
          
          # Verify directories exist
          if [ ! -d "$CORE_DIR" ]; then
            echo "âŒ Core directory does not exist: $CORE_DIR"
            exit 1
          fi
          if [ ! -d "$CONSENSUS_DIR" ]; then
            echo "âŒ Consensus directory does not exist: $CONSENSUS_DIR"
            exit 1
          fi
          if [ ! -d "$NODE_DIR" ]; then
            echo "âŒ Node directory does not exist: $NODE_DIR"
            exit 1
          fi
          
          # Create config.toml with absolute paths
          mkdir -p config
          {
            echo "[paths]"
            echo "core_path = \"$CORE_DIR\""
            echo "commons_consensus_path = \"$CONSENSUS_DIR\""
            echo "commons_node_path = \"$NODE_DIR\""
          } > config/config.toml
          echo "âœ… Created config/config.toml"
          echo "Config contents:"
          cat config/config.toml
          
          # Export paths for this step
          echo "core_path=$CORE_DIR" >> $GITHUB_OUTPUT
          echo "commons_consensus_path=$CONSENSUS_DIR" >> $GITHUB_OUTPUT
          echo "commons_node_path=$NODE_DIR" >> $GITHUB_OUTPUT
          
          echo ""
          echo "âœ… Setup complete:"
          echo "  CORE_PATH: $CORE_DIR"
          echo "  COMMONS_CONSENSUS_PATH: $CONSENSUS_DIR"
          echo "  COMMONS_NODE_PATH: $NODE_DIR"

      - name: Verify paths and set environment
        run: |
          # Get paths from previous step
          CORE_PATH="${{ steps.setup.outputs.core_path }}"
          COMMONS_CONSENSUS_PATH="${{ steps.setup.outputs.commons_consensus_path }}"
          COMMONS_NODE_PATH="${{ steps.setup.outputs.commons_node_path }}"
          
          echo "Verifying paths from setup step:"
          echo "  CORE_PATH: $CORE_PATH"
          echo "  COMMONS_CONSENSUS_PATH: $COMMONS_CONSENSUS_PATH"
          echo "  COMMONS_NODE_PATH: $COMMONS_NODE_PATH"
          
          # Verify they exist
          if [ ! -d "$COMMONS_CONSENSUS_PATH" ]; then
            echo "âŒ COMMONS_CONSENSUS_PATH does not exist: $COMMONS_CONSENSUS_PATH"
            exit 1
          fi
          if [ ! -d "$COMMONS_NODE_PATH" ]; then
            echo "âŒ COMMONS_NODE_PATH does not exist: $COMMONS_NODE_PATH"
            exit 1
          fi
          
          # Test path discovery
          echo ""
          echo "Testing path discovery..."
          source ./scripts/discover-paths.sh
          
          echo ""
          echo "Discovered paths:"
          echo "  CORE_PATH: ${CORE_PATH:-NOT SET}"
          echo "  COMMONS_CONSENSUS_PATH: ${COMMONS_CONSENSUS_PATH:-NOT SET}"
          echo "  COMMONS_NODE_PATH: ${COMMONS_NODE_PATH:-NOT SET}"
          
          if [ -z "$COMMONS_CONSENSUS_PATH" ]; then
            echo "âŒ COMMONS_CONSENSUS_PATH is still not set after discovery!"
            exit 1
          fi
          
          echo "âœ… Paths verified and ready"

      - name: Check dependencies
        env:
          CORE_PATH: ${{ steps.setup.outputs.core_path }}
          COMMONS_CONSENSUS_PATH: ${{ steps.setup.outputs.commons_consensus_path }}
          COMMONS_NODE_PATH: ${{ steps.setup.outputs.commons_node_path }}
        run: |
          export CORE_PATH="$CORE_PATH"
          export COMMONS_CONSENSUS_PATH="$COMMONS_CONSENSUS_PATH"
          export COMMONS_NODE_PATH="$COMMONS_NODE_PATH"
          ./scripts/check-dependencies.sh
          echo "âœ… Dependencies check passed"

      - name: Run benchmarks
        env:
          RUSTFLAGS: "-C target-cpu=native"
          CORE_PATH: ${{ steps.setup.outputs.core_path }}
          COMMONS_CONSENSUS_PATH: ${{ steps.setup.outputs.commons_consensus_path }}
          COMMONS_NODE_PATH: ${{ steps.setup.outputs.commons_node_path }}
        run: |
          # Explicitly export paths BEFORE running any scripts
          export CORE_PATH="$CORE_PATH"
          export COMMONS_CONSENSUS_PATH="$COMMONS_CONSENSUS_PATH"
          export COMMONS_NODE_PATH="$COMMONS_NODE_PATH"
          export BLLVM_BENCH_CONFIG="$(pwd)/config/config.toml"
          
          echo "Running benchmarks with paths:"
          echo "  CORE_PATH: $CORE_PATH"
          echo "  COMMONS_CONSENSUS_PATH: $COMMONS_CONSENSUS_PATH"
          echo "  COMMONS_NODE_PATH: $COMMONS_NODE_PATH"
          echo "  Config file: $BLLVM_BENCH_CONFIG"
          
          # Verify paths exist
          if [ ! -d "$COMMONS_CONSENSUS_PATH" ]; then
            echo "âŒ COMMONS_CONSENSUS_PATH does not exist: $COMMONS_CONSENSUS_PATH"
            exit 1
          fi
          if [ ! -d "$COMMONS_NODE_PATH" ]; then
            echo "âŒ COMMONS_NODE_PATH does not exist: $COMMONS_NODE_PATH"
            exit 1
          fi
          
          # Verify Core path exists (required for full coverage)
          if [ ! -d "$CORE_PATH" ]; then
            echo "âŒ CORE_PATH does not exist: $CORE_PATH"
            echo "   Core benchmarks are REQUIRED for full coverage"
            exit 1
          fi
          echo "âœ… Core path verified: $CORE_PATH"
          
          # Verify config file exists
          if [ ! -f "$BLLVM_BENCH_CONFIG" ]; then
            echo "âŒ Config file does not exist: $BLLVM_BENCH_CONFIG"
            exit 1
          fi
          
          echo "âœ… All paths verified:"
          echo "   CORE_PATH: $CORE_PATH"
          echo "   COMMONS_CONSENSUS_PATH: $COMMONS_CONSENSUS_PATH"
          echo "   COMMONS_NODE_PATH: $COMMONS_NODE_PATH"
          echo ""
          echo "ðŸš€ Running ALL benchmarks for FULL coverage..."
          # Run ALL benchmarks (both Core and Commons) for maximum coverage
          ./run-benchmarks.sh all 600
          
          # Verify benchmarks ran
          echo ""
          echo "=== Verifying benchmark execution ==="
          CORE_COUNT=$(find results -name "core-*.json" -type f | wc -l)
          COMMONS_COUNT=$(find results -name "commons-*.json" -type f | wc -l)
          echo "Core benchmarks generated: $CORE_COUNT"
          echo "Commons benchmarks generated: $COMMONS_COUNT"
          if [ "$CORE_COUNT" -eq 0 ]; then
            echo "âš ï¸  WARNING: No Core benchmarks generated! Full coverage not achieved."
          fi
          if [ "$COMMONS_COUNT" -eq 0 ]; then
            echo "âš ï¸  WARNING: No Commons benchmarks generated!"
          fi
          echo "Total: $((CORE_COUNT + COMMONS_COUNT)) benchmark files"

      - name: Generate consolidated JSON
        run: |
          make json

      - name: Validate consolidated JSON
        run: |
          LATEST_JSON=$(find results -name "benchmark-results-consolidated-*.json" -type f | sort | tail -1)
          if [ -n "$LATEST_JSON" ]; then
            ./scripts/validate-benchmark.sh "$LATEST_JSON" || echo "âš ï¸  Validation warnings"
          fi

      - name: Track history
        run: |
          LATEST_JSON=$(find results -name "benchmark-results-consolidated-*.json" -type f | sort | tail -1)
          if [ -n "$LATEST_JSON" ]; then
            ./scripts/track-history.sh "$LATEST_JSON" || echo "âš ï¸  History tracking failed"
          fi

      - name: Detect regressions
        continue-on-error: true
        run: |
          LATEST_JSON=$(find results -name "benchmark-results-consolidated-*.json" -type f | sort | tail -1)
          if [ -n "$LATEST_JSON" ]; then
            ./scripts/detect-regressions.sh "$LATEST_JSON" || echo "âš ï¸  Regressions detected (see report)"
          fi

      - name: Find latest consolidated JSON
        id: find_json
        run: |
          LATEST_JSON=$(find results -name "benchmark-results-consolidated-*.json" -type f | sort | tail -1)
          if [ -z "$LATEST_JSON" ]; then
            echo "âŒ No consolidated JSON found"
            exit 1
          fi
          echo "json_file=$LATEST_JSON" >> $GITHUB_OUTPUT
          echo "Found: $LATEST_JSON"

      - name: Create or Update Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: benchmarks-latest
          name: Latest Benchmark Results
          body: |
            Latest benchmark results from self-hosted runner.
            
            **Run Number:** ${{ github.run_number }}
            **Commit:** ${{ github.sha }}
            **Generated:** ${{ github.event.head_commit.timestamp || github.run_id }}
            
            The GitHub Pages site automatically loads data from this release.
            
            Download the consolidated JSON from the assets below.
          files: |
            ${{ steps.find_json.outputs.json_file }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Upload benchmark artifacts
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: |
            results/benchmark-results-consolidated-*.json
            docs/data/benchmark-results-consolidated-latest.json
          retention-days: 30

